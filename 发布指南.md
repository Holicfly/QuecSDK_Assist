# 移远SDK辅助工具 - 发布与升级指南

## 目录
- [软件发布流程](#软件发布流程)
- [远程升级流程](#远程升级流程)
- [本地验证远程升级](#本地验证远程升级)
- [更新服务器启动方法](#更新服务器启动方法)
- [常见问题](#常见问题)

## 软件发布流程

### 1. 准备发布

1. **更新版本号**：
   在 `package.json` 文件中更新 `version` 字段，遵循语义化版本规范（X.Y.Z）：
   - X: 主版本号 - 不兼容的API修改
   - Y: 次版本号 - 向下兼容的功能性新增
   - Z: 修订号 - 向下兼容的问题修正

2. **控制台开关设置**：
   在 `main/main.js` 文件中，根据需要设置控制台开关：
   ```javascript
   const CONFIG = {
     // 是否在生产环境中显示开发者控制台
     showDevToolsInProduction: false  // 发布时设为false
   };
   ```

3. **测试应用**：
   ```bash
   npm run build
   npm run start
   ```
   确保应用在生产环境下正常运行，没有明显错误。

### 2. 构建应用

1. **标准构建**（不发布更新）：
   ```bash
   npm run build:electron
   ```
   这将生成安装包到 `dist_electron` 目录。

2. **发布构建**（包含更新信息）：
   ```bash
   npm run publish
   ```
   这将生成安装包并准备更新信息文件。

### 3. 分发应用

1. **首次发布**：
   - 分发 `dist_electron` 目录下的安装程序（.exe文件）给用户
   - 用户安装后即可使用

2. **后续更新**：
   - 将 `dist_electron` 目录下的所有文件部署到更新服务器
   - 已安装的应用将自动检测并提示更新

## 远程升级流程

### 1. 更新服务器设置

当前配置使用本地计算机作为更新服务器，IP地址为 `172.168.2.16`，端口为 `9090`。

1. **确认配置**：
   检查 `package.json` 中的发布配置：
   ```json
   "publish": [
     {
       "provider": "generic",
       "url": "http://172.168.2.16:9090/"
     }
   ]
   ```

2. **启动更新服务器**：
   ```bash
   npm run serve:update
   ```
   这将在 `dist_electron` 目录启动一个HTTP服务器，端口为9090。

### 2. 更新检测机制

应用提供了两种检测更新的方式：

1. **自动检测**：
   - 应用启动时会自动检测是否有新版本
   - 如果发现新版本，会提示用户下载安装

2. **手动检测**：
   - 用户可以点击界面右下角的更新图标手动检查更新
   - 无需重启应用即可检测和安装更新

### 3. 发布新版本

1. **更新版本号**：
   在 `package.json` 中增加版本号（例如从 1.0.1 改为 1.0.2）。

2. **构建并发布**：
   ```bash
   npm run publish
   ```

3. **确保服务器运行**：
   ```bash
   npm run serve:update
   ```

4. **验证更新文件**：
   检查 `dist_electron` 目录中是否存在以下文件：
   - `latest.yml`：包含最新版本信息
   - 新版本的安装程序（.exe文件）

5. **测试手动更新**：
   - 在旧版本应用中，点击右下角的更新图标
   - 应用会检查并提示发现新版本
   - 按照提示完成更新安装

## 本地验证远程升级

### 1. 准备环境

1. **确认IP地址**：
   - 确保您的电脑IP地址与 `package.json` 中配置的一致（172.168.2.16）
   - 如需更改，请修改 `package.json` 中的 `url` 字段

2. **防火墙设置**：
   - 确保端口9090未被防火墙阻止
   - 必要时添加防火墙例外规则

### 2. 测试流程

1. **安装旧版本**：
   - 构建并安装一个较低版本的应用
   - 记录当前版本号

2. **准备新版本**：
   - 增加 `package.json` 中的版本号
   - 运行 `npm run publish` 构建新版本

3. **启动更新服务器**：
   ```bash
   npm run serve:update
   ```

4. **验证更新过程**：
   - 启动已安装的旧版本应用
   - 应用应自动检测到新版本并提示更新
   - 点击"是"下载更新
   - 下载完成后，应提示安装并重启
   - 确认应用重启后版本已更新

## 更新服务器启动方法

您可以在任何位置启动更新服务器，不必在应用安装目录。更新服务器只需要能访问到包含`latest.yml`和安装程序的文件夹即可。

### 方法一：使用通用更新服务器脚本（推荐）

我已为您创建了一个通用的更新服务器启动脚本`通用更新服务器.bat`，您可以将此文件放在任何位置，然后双击运行：

```batch
@echo off
echo 移远SDK辅助工具 - 更新服务器启动工具

REM 检查是否已安装http-server
where http-server >nul 2>nul
if %ERRORLEVEL% NEQ 0 (
    echo 未找到http-server，正在安装...
    npm install -g http-server
    if %ERRORLEVEL% NEQ 0 (
        echo 安装http-server失败，请确保已安装Node.js并以管理员权限运行此脚本
        pause
        exit /b 1
    )
)

:INPUT_PATH
set /p UPDATE_DIR="请输入更新文件所在目录（包含latest.yml和安装程序的文件夹）: "

if not exist "%UPDATE_DIR%" (
    echo 目录不存在，请重新输入
    goto INPUT_PATH
)

if not exist "%UPDATE_DIR%\latest.yml" (
    echo 警告：目录中未找到latest.yml文件，这可能不是有效的更新目录
    choice /c YN /m "是否继续？"
    if %ERRORLEVEL% EQU 2 goto INPUT_PATH
)

cd /d "%UPDATE_DIR%"
echo.
echo 正在启动更新服务器，目录: %CD%
echo 服务器地址: http://localhost:9090/
echo 请确保在package.json中的更新URL配置正确
echo 按Ctrl+C可以停止服务器
echo.

http-server -p 9090

echo 服务器已关闭
pause
```

**使用步骤：**

1. 双击运行`通用更新服务器.bat`
2. 在提示中输入更新文件所在的目录路径（通常是开发项目中的`dist_electron`文件夹）
3. 脚本会检查目录是否有效，然后启动更新服务器

### 方法二：使用命令行

如果您熟悉命令行，可以直接使用以下命令启动更新服务器：

```bash
# 安装http-server（如果尚未安装）
npm install -g http-server

# 进入包含更新文件的目录
cd 路径/到/dist_electron

# 启动服务器
http-server -p 9090
```

### 方法三：在开发环境中使用npm脚本

在开发环境中（即源代码目录），您可以使用package.json中定义的脚本：

```bash
npm run serve:update
```

### 关于更新服务器的说明

1. **服务器位置灵活性**：更新服务器可以在任何能访问到更新文件的位置启动，不必在应用安装目录
2. **必要文件**：服务器目录需要包含`latest.yml`和新版本的安装程序
3. **IP地址配置**：确保应用的`package.json`中配置的URL与实际启动的服务器地址匹配
4. **防火墙设置**：确保服务器端口（默认9090）未被防火墙阻止

## 常见问题

### 更新未被检测到

1. **检查服务器**：
   - 确认更新服务器正在运行
   - 浏览器访问 `http://172.168.2.16:9090/latest.yml` 确认可以访问

2. **检查版本号**：
   - 确保新版本的版本号高于当前安装的版本

3. **检查网络**：
   - 确认应用可以访问更新服务器
   - 检查防火墙设置

### 更新下载失败

1. **检查日志**：
   - 查看应用日志（位于用户数据目录下的 `logs.txt`）
   - 查找与更新相关的错误信息

2. **检查存储空间**：
   - 确保目标设备有足够的存储空间

### 更新后白屏问题

如果更新后出现白屏：

1. **检查资源路径**：
   - 确保 `vite.config.js` 中的 `base` 设置为 `'./'`

2. **检查文件完整性**：
   - 确保所有必要的文件都包含在构建中
   - 检查 `package.json` 中的 `files` 配置是否正确 

### 无法通过IP地址访问更新服务器

如果您可以通过`http://127.0.0.1:9090`或`http://localhost:9090`访问更新服务器，但无法通过本机IP地址（如`http://172.168.2.16:9090`）访问，这通常是由以下原因导致的：

1. **防火墙阻止**：Windows防火墙可能阻止了外部IP访问9090端口
   - 运行提供的`防火墙检查.bat`脚本检查并添加防火墙例外
   - 或手动添加防火墙规则：控制面板 > Windows Defender防火墙 > 高级设置 > 入站规则 > 新建规则

2. **杀毒软件拦截**：某些杀毒软件可能会阻止外部连接
   - 检查杀毒软件设置，临时禁用或添加例外

3. **网络配置问题**：
   - 确认IP地址是否正确（可通过`ipconfig`命令查看）
   - 检查是否有多个网络适配器，确保使用正确的IP地址

4. **http-server绑定问题**：
   - 尝试使用`--host 0.0.0.0`参数启动http-server：
     ```
     http-server -p 9090 --host 0.0.0.0
     ```

5. **测试连接**：
   - 在命令行中使用`curl`测试连接：
     ```
     curl http://127.0.0.1:9090/latest.yml
     curl http://172.168.2.16:9090/latest.yml
     ```
   - 或使用`telnet`测试端口是否开放：
     ```
     telnet 172.168.2.16 9090
     ```

6. **修改更新服务器脚本**：
   如果问题仍然存在，可以修改`通用更新服务器.bat`，添加`--host 0.0.0.0`参数：
   ```batch
   http-server -p 9090 --host 0.0.0.0
   ```

### 局域网内其他设备无法访问更新服务器

如果您想让局域网内的其他设备也能访问您的更新服务器：

1. **确保防火墙已配置**：按照上面的步骤添加防火墙例外

2. **检查网络发现**：
   - 确保网络发现已开启：控制面板 > 网络和共享中心 > 更改高级共享设置
   - 确保"网络发现"和"文件和打印机共享"已启用

3. **使用正确的URL**：
   - 在其他设备上使用您电脑的IP地址访问：`http://172.168.2.16:9090`
   - 确保其他设备与您的电脑在同一局域网内 